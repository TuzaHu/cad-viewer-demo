<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Model Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        #header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        #header h1 {
            color: #667eea;
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        #navigation {
            position: absolute;
            top: 20px;
            right: 30px;
            z-index: 100;
        }
        
        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            margin-left: 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .settings-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            margin-left: 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .settings-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .settings-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        
        #controls {
            display: none;
        }
        
        #controls.show {
            display: block;
            position: absolute;
            bottom: 30px;
            left: 30px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            max-width: 320px;
        }
        
        .control-group {
            top: 15px; left: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #667eea;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .control-group input[type="range"] {
            width: 150px;
            margin-right: 10px;
        }
        
        .file-upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 2px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .file-upload-btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .collapsible-section {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .collapsible-header {
            background: rgba(102, 126, 234, 0.1);
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: #667eea;
            transition: background 0.3s ease;
        }
        
        .collapsible-header:hover {
            background: rgba(102, 126, 234, 0.2);
        }
        
        .collapsible-header::after {
            content: '▼';
            font-size: 10px;
            transition: transform 0.3s ease;
        }
        
        .collapsible-header.collapsed::after {
            transform: rotate(-90deg);
        }
        
        .collapsible-content {
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            max-height: 200px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .collapsible-content.collapsed {
            max-height: 0;
            padding: 0 12px;
        }
        
        .essential-controls {
            background: rgba(0, 100, 0, 0.1);
            border: 1px solid rgba(0, 100, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            top: 15px; left: 15px;
        }
        
        .essential-controls label {
            color: #4caf50;
        }
        
        #status {
            display: none;
        }
        
        #status.show {
            display: block;
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #667eea;
            font-size: 11px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }
        
        #loading {
            display: none;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #instructions {
            position: absolute;
            top: 100px;
            left: 30px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            max-width: 300px;
        }
        
        #instructions h3 {
            color: #667eea;
            margin-top: 0;
            top: 15px; left: 15px;
        }
        
        #instructions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        #instructions li {
            margin-bottom: 8px;
            font-size: 11px;
        }
        
        @media (max-width: 768px) {
            #header {
                padding: 10px 20px;
            }
            
            #header h1 {
                font-size: 20px;
            }
            
            #navigation {
                top: 15px;
                right: 20px;
            }
            
            .nav-btn {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            #controls.show {
                bottom: 15px;
                left: 15px;
                padding: 15px;
                border-radius: 10px;
                max-width: calc(100vw - 30px);
                max-height: 70vh;
                overflow-y: auto;
            }
            
            .control-group {
                margin-bottom: 12px;
            }
            
            .control-group label {
                font-size: 11px;
            }
            
            .file-upload-btn {
                padding: 6px 10px;
                font-size: 10px;
                margin: 1px;
            }
            
            #status.show {
                bottom: 15px;
                right: 15px;
                padding: 10px 12px;
                font-size: 12px;
                min-width: 120px;
            }
            
            #instructions {
                top: 60px;
                left: 15px;
                padding: 15px;
                border-radius: 10px;
                max-width: 250px;
            }
            
            #instructions h3 {
                font-size: 16px;
            }
            
            #instructions ul {
                padding-left: 15px;
            }
            
            #instructions li {
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            #header {
                padding: 8px 15px;
            }
            
            #header h1 {
                font-size: 18px;
            }
            
            #navigation {
                top: 12px;
                right: 15px;
            }
            
            .nav-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            #controls.show {
                bottom: 10px;
                left: 10px;
                padding: 12px;
                border-radius: 8px;
                max-width: calc(100vw - 20px);
                max-height: 60vh;
            }
            
            .control-group {
                margin-bottom: 10px;
            }
            
            .control-group label {
                font-size: 10px;
            }
            
            .file-upload-btn {
                padding: 5px 8px;
                font-size: 9px;
            }
            
            #status.show {
                bottom: 10px;
                right: 10px;
                padding: 8px 10px;
                font-size: 11px;
                min-width: 100px;
            }
            
            #instructions {
                top: 50px;
                left: 10px;
                padding: 12px;
                border-radius: 8px;
                max-width: 200px;
            }
            
            #instructions h3 {
                font-size: 14px;
            }
            
            #instructions li {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        
        <div id="header">
            <h1>CAD Model Viewer</h1>
        </div>
        
        <div id="navigation">
            <button id="settingsBtn" class="settings-btn">⚙️ Settings</button>
            <a href="index.html" class="nav-btn">← Animation Player</a>
        </div>
        
        <div id="controls">
            <div class="essential-controls">
                <label>Camera Distance</label>
                <input type="range" id="cameraDistance" min="1" max="50" value="10" step="0.1">
                <span id="distanceValue">10</span>
            </div>
            
            <div class="essential-controls">
                <label>Model Scale</label>
                <input type="range" id="modelScale" min="0.1" max="5" value="1" step="0.1">
                <span id="scaleValue">1.0</span>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header">Gizmo Mode</div>
                <div class="collapsible-content">
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <button id="rotateMode" class="file-upload-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 5px 10px; font-size: 11px;">
                            🔄 Rotate
                        </button>
                        <button id="translateMode" class="file-upload-btn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); padding: 5px 10px; font-size: 11px;">
                            ↔️ Move
                        </button>
                        <button id="scaleMode" class="file-upload-btn" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); padding: 5px 10px; font-size: 11px;">
                            📏 Scale
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header">Gizmo Size</div>
                <div class="collapsible-content">
                    <input type="range" id="gizmoSize" min="0.3" max="2" value="0.8" step="0.1">
                    <span id="sizeValue">0.8</span>
                </div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header">Standard Views</div>
                <div class="collapsible-content">
                    <div style="display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap;">
                        <button id="viewFront" class="file-upload-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 5px 10px; font-size: 11px;">
                            🎯 Front
                        </button>
                        <button id="viewBack" class="file-upload-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 5px 10px; font-size: 11px;">
                            🎯 Back
                        </button>
                        <button id="viewTop" class="file-upload-btn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); padding: 5px 10px; font-size: 11px;">
                            🔝 Top
                        </button>
                        <button id="viewBottom" class="file-upload-btn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); padding: 5px 10px; font-size: 11px;">
                            🔽 Bottom
                        </button>
                        <button id="viewRight" class="file-upload-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 5px 10px; font-size: 11px;">
                            ➡️ Right
                        </button>
                        <button id="viewLeft" class="file-upload-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 5px 10px; font-size: 11px;">
                            ⬅️ Left
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header">Coordinate System</div>
                <div class="collapsible-content">
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <button id="fixAxes" class="file-upload-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 5px 10px; font-size: 11px;">
                            🔧 Fix Y/Z
                        </button>
                        <button id="fixAxesZ" class="file-upload-btn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); padding: 5px 10px; font-size: 11px;">
                            🔧 Fix X/Y
                        </button>
                        <button id="resetAxes" class="file-upload-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); padding: 5px 10px; font-size: 11px;">
                            🔄 Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="collapsible-section">
                <div class="collapsible-header">File Upload</div>
                <div class="collapsible-content">
                    <input type="file" id="modelFile" accept=".gltf,.glb,.obj,.stl" style="display: none;">
                    <button class="file-upload-btn" onclick="document.getElementById('modelFile').click()">
                        📁 Upload Model
                    </button>
                    <button id="resetView" class="file-upload-btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);">
                        🔄 Reset View
                    </button>
                </div>
            </div>
        </div>
        
        <div id="status">Ready to load 3D models</div>
        
        <div id="loading">
            <div class="spinner"></div>
            Loading 3D model...
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    
    <script>
        class CADViewer {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.transformControls = null;
                this.model = null;
                
                this.init();
                this.setupEventListeners();
                this.animate();
                
                // Auto-load demo model
                this.loadDefaultModel();
            }
            
            init() {
                // Scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x1a1a1a);
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                this.camera.position.set(10, 10, 10);
                this.camera.lookAt(0, 0, 0);
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ 
                    canvas: document.getElementById('canvas'),
                    antialias: true 
                });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // Load background
                this.loadBackground();
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);
                
                const pointLight1 = new THREE.PointLight(0xffffff, 0.6, 100);
                pointLight1.position.set(-10, 10, 10);
                this.scene.add(pointLight1);
                
                const pointLight2 = new THREE.PointLight(0xffffff, 0.6, 100);
                pointLight2.position.set(10, -10, -10);
                this.scene.add(pointLight2);
                
                // Controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.1;
                this.controls.target.set(0, 0, 0);
                
                // Transform Controls
                this.transformControls = new THREE.TransformControls(this.camera, this.renderer.domElement);
                this.transformControls.setMode('rotate');
                this.transformControls.setSize(0.8);
                this.scene.add(this.transformControls);
                
                // Disable orbit controls when using transform controls
                this.transformControls.addEventListener('dragging-changed', (event) => {
                    // Hide gizmo controls by default on mobile
                    if (window.innerWidth <= 768) {
                        this.transformControls.visible = false;
                    }
                    this.controls.enabled = !event.value;
                });
                
                this.updateStatus('CAD Viewer initialized');
            }
            
            async loadBackground() {
                try {
                    const loader = new THREE.TextureLoader();
                    const texture = await new Promise((resolve, reject) => {
                        loader.load('images/Background.png', resolve, undefined, reject);
                    });
                    
                    // Create background plane
                    const geometry = new THREE.PlaneGeometry(50, 30);
                    const material = new THREE.MeshBasicMaterial({ 
                        map: texture,
                        transparent: true,
                        opacity: 0.3
                    });
                    const backgroundPlane = new THREE.Mesh(geometry, material);
                    backgroundPlane.position.z = -20;
                    this.scene.add(backgroundPlane);
                    
                    this.updateStatus('Background loaded');
                } catch (error) {
                    console.log('Background image not found, using default');
                }
            }
            
            async loadDefaultModel() {
                try {
                    this.showLoading(true);
                    this.updateStatus('Loading default model...');
                    
                    const objLoader = new THREE.OBJLoader();
                    const model = await new Promise((resolve, reject) => {
                        objLoader.load('models/pipe_Demo.obj', resolve, undefined, reject);
                    });
                    
                    this.setModel(model);
                    this.updateStatus('Default model loaded successfully');
                } catch (error) {
                    console.log('Default model not found, showing placeholder');
                    this.createPlaceholderModel();
                }
                this.showLoading(false);
            }
            
            createPlaceholderModel() {
                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshLambertMaterial({ color: 0x667eea });
                const cube = new THREE.Mesh(geometry, material);
                this.setModel(cube);
                this.updateStatus('Placeholder model loaded - Upload your own model');
            }
            
            setModel(model) {
                // Remove existing model
                if (this.model) {
                    this.scene.remove(this.model);
                    this.transformControls.detach();
                }
                
                this.model = model;
                this.scene.add(this.model);
                
                // Attach transform controls
                this.transformControls.attach(this.model);
                
                // Center and scale model
                this.centerAndScaleModel();
            }
            
            centerAndScaleModel() {
                if (!this.model) return;
                
                // Reset transformations
                this.model.position.set(0, 0, 0);
                this.model.rotation.set(0, 0, 0);
                this.model.scale.setScalar(1);
                
                // Calculate bounding box
                const box = new THREE.Box3().setFromObject(this.model);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                
                // Center the model
                this.model.position.copy(center).multiplyScalar(-1);
                
                // Scale to fit in view
                const maxDim = Math.max(size.x, size.y, size.z);
                if (maxDim > 10) {
                    const scale = 10 / maxDim;
                    this.model.scale.setScalar(scale);
                }
                
                // Apply axis correction for better orientation
                this.model.rotation.x = Math.PI / 2;
                
                // Recalculate bounding box after transformations
                const finalBox = new THREE.Box3().setFromObject(this.model);
                const finalCenter = finalBox.getCenter(new THREE.Vector3());
                this.model.position.copy(finalCenter).multiplyScalar(-1);
                
                // Ensure the model is at the origin
                this.model.position.set(0, 0, 0);
                
                // Reset sliders
                document.getElementById('modelScale').value = 1;
                document.getElementById('scaleValue').textContent = '1.0';
            }
            
            setupEventListeners() {
                // Camera distance control
                document.getElementById('cameraDistance').addEventListener('input', (e) => {
                    const distance = parseFloat(e.target.value);
                    const direction = new THREE.Vector3();
                    this.camera.getWorldDirection(direction);
                    this.camera.position.copy(direction.multiplyScalar(-distance));
                    document.getElementById('distanceValue').textContent = distance;
                });
                
                // Model scale control
                document.getElementById('modelScale').addEventListener('input', (e) => {
                    const scale = parseFloat(e.target.value);
                    if (this.model) {
                        this.model.scale.setScalar(scale);
                    }
                    document.getElementById('scaleValue').textContent = scale.toFixed(1);
                });
                
                // Gizmo mode controls
                document.getElementById('rotateMode').addEventListener('click', () => {
                    this.transformControls.setMode('rotate');
                    this.updateStatus('Rotate mode - Drag colored rings');
                });
                
                document.getElementById('translateMode').addEventListener('click', () => {
                    this.transformControls.setMode('translate');
                    this.updateStatus('Move mode - Drag colored arrows');
                });
                
                document.getElementById('scaleMode').addEventListener('click', () => {
                    this.transformControls.setMode('scale');
                    this.updateStatus('Scale mode - Drag colored cubes');
                });
                
                // Gizmo size control
                document.getElementById('gizmoSize').addEventListener('input', (e) => {
                    const size = parseFloat(e.target.value);
                    this.transformControls.setSize(size);
                    document.getElementById('sizeValue').textContent = size.toFixed(1);
                });
                
                // Coordinate system controls
                document.getElementById('fixAxes').addEventListener('click', () => {
                    if (this.model) {
                        this.model.rotation.x = Math.PI / 2;
                        this.updateStatus('Y/Z axes fixed - X rotation applied');
                    }
                });
                
                document.getElementById('fixAxesZ').addEventListener('click', () => {
                    if (this.model) {
                        this.model.rotation.z = Math.PI / 2;
                        this.updateStatus('X/Y axes fixed - Z rotation applied');
                    }
                });
                
                document.getElementById('resetAxes').addEventListener('click', () => {
                    if (this.model) {
                        this.model.rotation.set(0, 0, 0);
                        this.updateStatus('All axes reset to original');
                    }
                });
                
                // Standard view controls
                document.getElementById('viewFront').addEventListener('click', () => {
                    this.setCameraView('front');
                    this.updateStatus('Front view');
                });
                
                document.getElementById('viewBack').addEventListener('click', () => {
                    this.setCameraView('back');
                    this.updateStatus('Back view');
                });
                
                document.getElementById('viewTop').addEventListener('click', () => {
                    this.setCameraView('top');
                    this.updateStatus('Top view');
                });
                
                document.getElementById('viewBottom').addEventListener('click', () => {
                    this.setCameraView('bottom');
                    this.updateStatus('Bottom view');
                });
                
                document.getElementById('viewRight').addEventListener('click', () => {
                    this.setCameraView('right');
                    this.updateStatus('Right view');
                });
                
                document.getElementById('viewLeft').addEventListener('click', () => {
                    this.setCameraView('left');
                    this.updateStatus('Left view');
                });
                
                // File upload
                document.getElementById('modelFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.loadModelFile(file);
                    }
                });
                
                // Reset view
                document.getElementById('resetView').addEventListener('click', () => {
                    this.resetView();
                });
                
                // Collapsible sections functionality
                this.setupCollapsibleSections();
                
                // Settings button functionality
                this.setupSettingsButton();
                
                // Window resize
                window.addEventListener('resize', () => this.onWindowResize());
            }
            
            async loadModelFile(file) {
                try {
                    this.showLoading(true);
                    this.updateStatus(`Loading ${file.name}...`);
                    
                    const url = URL.createObjectURL(file);
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    let model;
                    switch (extension) {
                        case 'gltf':
                        case 'glb':
                            model = await this.loadGLTFModel(url);
                            break;
                        case 'obj':
                            model = await this.loadOBJModel(url);
                            break;
                        case 'stl':
                            model = await this.loadSTLModel(url);
                            break;
                        default:
                            throw new Error('Unsupported file format');
                    }
                    
                    this.setModel(model);
                    this.updateStatus(`${file.name} loaded successfully`);
                    
                    URL.revokeObjectURL(url);
                } catch (error) {
                    this.updateStatus(`Error loading ${file.name}: ${error.message}`);
                } finally {
                    this.showLoading(false);
                }
            }
            
            async loadGLTFModel(url) {
                const loader = new THREE.GLTFLoader();
                return new Promise((resolve, reject) => {
                    loader.load(url, (gltf) => resolve(gltf.scene), undefined, reject);
                });
            }
            
            async loadOBJModel(url) {
                const loader = new THREE.OBJLoader();
                return new Promise((resolve, reject) => {
                    loader.load(url, resolve, undefined, reject);
                });
            }
            
            async loadSTLModel(url) {
                const loader = new THREE.STLLoader();
                return new Promise((resolve, reject) => {
                    loader.load(url, (geometry) => {
                        const material = new THREE.MeshLambertMaterial({ color: 0x667eea });
                        const mesh = new THREE.Mesh(geometry, material);
                        resolve(mesh);
                    }, undefined, reject);
                });
            }
            
            resetView() {
                this.camera.position.set(10, 10, 10);
                this.controls.target.set(0, 0, 0);
                this.controls.update();
                
                // Reset sliders
                document.getElementById('cameraDistance').value = 10;
                document.getElementById('distanceValue').textContent = '10';
                
                if (this.model) {
                    // Reset model position and rotation
                    this.model.position.set(0, 0, 0);
                    this.model.rotation.set(0, 0, 0);
                    this.model.scale.setScalar(1);
                    
                    document.getElementById('modelScale').value = 1;
                    document.getElementById('scaleValue').textContent = '1.0';
                }
                
                this.updateStatus('View reset');
            }
            
            setCameraView(view) {
                const distance = 15;
                
                switch (view) {
                    case 'front':
                        this.camera.position.set(0, 0, distance);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'back':
                        this.camera.position.set(0, 0, -distance);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'top':
                        this.camera.position.set(0, distance, 0);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'bottom':
                        this.camera.position.set(0, -distance, 0);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'right':
                        this.camera.position.set(distance, 0, 0);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    case 'left':
                        this.camera.position.set(-distance, 0, 0);
                        this.camera.lookAt(0, 0, 0);
                        break;
                    default:
                        this.camera.position.set(10, 10, 10);
                        this.camera.lookAt(0, 0, 0);
                }
                
                // Always look at the center
                this.controls.target.set(0, 0, 0);
                this.controls.update();
                
                // Update distance slider
                document.getElementById('cameraDistance').value = distance;
                document.getElementById('distanceValue').textContent = distance;
            }
            
            setupCollapsibleSections() {
                const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
                
                collapsibleHeaders.forEach(header => {
                    header.addEventListener('click', () => {
                        const content = header.nextElementSibling;
                        const isCollapsed = content.classList.contains('collapsed');
                        
                        if (isCollapsed) {
                            content.classList.remove('collapsed');
                            header.classList.remove('collapsed');
                        } else {
                            content.classList.add('collapsed');
                            header.classList.add('collapsed');
                        }
                    });
                });
                
                // Start with all sections collapsed on mobile
                if (window.innerWidth <= 768) {
                    const contents = document.querySelectorAll('.collapsible-content');
                    const headers = document.querySelectorAll('.collapsible-header');
                    contents.forEach(content => content.classList.add('collapsed'));
                    headers.forEach(header => header.classList.add('collapsed'));
                }
            }
            
            setupSettingsButton() {
                const settingsBtn = document.getElementById("settingsBtn");
                const controlsPanel = document.getElementById("controls");
                const statusPanel = document.getElementById("status");
                
                settingsBtn.addEventListener("click", () => {
                    const isActive = settingsBtn.classList.contains("active");
                    
                    if (isActive) {
                        // Hide everything
                        settingsBtn.classList.remove("active");
                        settingsBtn.textContent = "⚙️ Settings";
                        controlsPanel.classList.remove("show");
                        statusPanel.classList.remove("show");
                        // Hide gizmo controls
                        if (this.transformControls) {
                            this.transformControls.visible = false;
                        }
                    } else {
                        // Show everything
                        settingsBtn.classList.add("active");
                        settingsBtn.textContent = "✕ Close";
                        controlsPanel.classList.add("show");
                        statusPanel.classList.add("show");
                        // Show gizmo controls
                        if (this.transformControls) {
                            this.transformControls.visible = true;
                        }
                    }
                });
            }
            
            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }
            
            updateStatus(message) {
                document.getElementById('status').textContent = message;
                console.log('Status:', message);
            }
            
            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                
                // Update orbit controls
                this.controls.update();
                
                // Render
                this.renderer.render(this.scene, this.camera);
            }
        }
        
        // Initialize the CAD Viewer when the page loads
        window.addEventListener('load', () => {
            console.log('Page loaded, creating CAD Viewer...');
            new CADViewer();
        });
    </script>
</body>
</html>